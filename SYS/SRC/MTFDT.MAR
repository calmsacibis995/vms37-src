	.TITLE	MTFDT - MAGTAPE FUNCTION DECISION TABLE ROUTINES
	.IDENT	'V03-000'
 
;
;****************************************************************************
;*									    *
;*  COPYRIGHT (c) 1978, 1980, 1982 BY					    *
;*  DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASSACHUSETTS.		    *
;*  ALL RIGHTS RESERVED.						    *
;* 									    *
;*  THIS SOFTWARE IS FURNISHED UNDER A LICENSE AND MAY BE USED AND COPIED   *
;*  ONLY IN  ACCORDANCE WITH  THE  TERMS  OF  SUCH  LICENSE  AND WITH THE   *
;*  INCLUSION OF THE ABOVE COPYRIGHT NOTICE. THIS SOFTWARE OR  ANY  OTHER   *
;*  COPIES THEREOF MAY NOT BE PROVIDED OR OTHERWISE MADE AVAILABLE TO ANY   *
;*  OTHER PERSON.  NO TITLE TO AND OWNERSHIP OF  THE  SOFTWARE IS  HEREBY   *
;*  TRANSFERRED.							    *
;* 									    *
;*  THE INFORMATION IN THIS SOFTWARE IS  SUBJECT TO CHANGE WITHOUT NOTICE   *
;*  AND  SHOULD  NOT  BE  CONSTRUED AS  A COMMITMENT BY DIGITAL EQUIPMENT   *
;*  CORPORATION.							    *
;* 									    *
;*  DIGITAL ASSUMES NO RESPONSIBILITY FOR THE USE  OR  RELIABILITY OF ITS   *
;*  SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DIGITAL.		    *
;* 									    *
;*									    *
;****************************************************************************
;
; D. N. CUTLER 29-JUN-77
;
; MAGTAPE FUNCTION DECISION TABLE ROUTINES
;
; MODIFIED BY:
;
;	V0003	RLR0001		Robert Rappaport	11-March-1980
;		Added error return code when volume software write locked.
;	V0002	ACG0047		Andrew C. Goldstein,	8-Aug-1979  17:05
;		Protection check interface changes
;
;
; MACRO LIBRARY CALLS
;
 
	$DEVDEF				;DEFINE DEVICE CHARACTERISTIC BITS
	$PCBDEF				;DEFINE PCB OFFSETS
	$SSDEF				;DEFINE SYSTEM STATUS VALUES
	$UCBDEF				;DEFINE UCB OFFSETS
	.PAGE
	.SBTTL	CHECK ACCESS RIGHTS FOR CONTROL WRITE FUNCTIONS
;+
; MT$CHECK_ACCESS - CHECK ACCESS RIGHTS FOR CONTROL WRITE FUNCTIONS
;
; THIS ROUTINE IS CALLED BY THE FUNCTION DECISION TABLE DISPATCHER WHEN A WRITE
; TAPE MARK OR ERASE TAPE FUNCTION IS ENCOUNTERED. ITS FUNCTION IS TO CHECK THE
; ACCESS RIGHTS OF THE REQUESTING PROCESS.
;
; INPUTS:
;
;	R0 = SCRATCH.
;	R1 = SCRATCH.
;	R2 = SCRATCH.
;	R3 = ADDRESS OF I/O REQUEST PACKET.
;	R4 = CURRENT PROCESS PCB ADDRESS.
;	R5 = ASSIGNED DEVICE UCB ADDRESS.
;	R6 = ADDRESS OF CCB.
;	R7 = I/O FUNCTION CODE BIT NUMBER.
;	R8 = FUNCTION DECISION TABLE DISPATCH ADDRESS.
;	R9 = SCRATCH.
;	R10 = SCRATCH.
;	R11 = SCRATCH.
;	AP = ADDRESS OF FIRST FUNCTION DEPENDENT PARAMETER.
;
; OUTPUTS:
;
;	THE ACCESS RIGHTS OF THE REQUESTING PROCESS ARE CHECKED TO DETERMINE
;	WHETHER A CONTROL WRITE FUNCTION CAN BE PERFORMED. IF THE REQUESTING
;	PROCESS DOES NOT HAVE SUFFICIENT PRIVILEGE, THEN THE I/O FUNCTION IS
;	ABORTED WITH A STATUS OF SS$_NOPRIV. OTHERWISE A RETURN TO THE FUNCTION
;	DECISION TABLE DISPATCHER IS EXECUTED.
;-
 
MT$CHECK_ACCESS::			;CHECK ACCESS RIGHTS FOR CONTROL WRITE
	MOVZWL	#SS$_WRITLCK,R0			 ; Set error code just in case.
	BBS	#DEV$V_SWL,UCB$L_DEVCHAR(R5),10$ ;IF SET, SOFTWARE WRITE LOCKED
	MOVL	PCB$L_ARB(R4),R0	;GET ACCESS RIGHTS BLOCK ADDR
	MOVZWL	UCB$W_VPROT(R5),R1	;GET VOLUME PROTECTION MASK
	MOVL	UCB$L_OWNUIC(R5),R2	;GET VOLUME OWNER UIC
	BSBW	EXE$CHKWRTACCES		;WRITE FOR WRITE ACCESS TO VOLUME
	BLBC	R0,10$			;IF LBC ACCESS DENIED
	RSB				;
10$:	BRW	EXE$ABORTIO		;ABORT I/O OPERATION (STATUS = SS$_NOPRIV)
 
	.END
